#!/usr/bin/env bash
set -euo pipefail

mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.local/source"

GIT_REPOS=(
    "https://github.com/racakenon/kime"
    "https://github.com/alacritty/alacritty"
    "https://github.com/YaLTeR/niri"
    "https://github.com/LGFae/swww"
    "https://github.com/DorianRudolph/sirula.git"
    "https://github.com/Kitware/CMake.git"
)

gc() {
    local repo_url="$1"
    local repo_name
    repo_name=$(basename "$repo_url" .git)
    local repo_dir="$HOME/.local/source/$repo_name"

    if [[ -d "$repo_dir/.git" ]]; then
        echo "[update] $repo_name..."
        git -C "$repo_dir" pull --rebase --autostash
        echo "[done] $repo_name updated"
    else
        echo "[clone] $repo_name..."
        git clone --depth 1 "$repo_url" "$repo_dir"
        echo "[done] $repo_name cloned"
    fi
}

update_all_repos() {
    echo "=== Updating all repositories ==="
    for repo in "${GIT_REPOS[@]}"; do
        gc "$repo"
    done
    echo "=== All repositories updated ==="
}

if [[ ! "$(uname -r)" == *WSL* ]]; then
    update_all_repos
else
    echo "[skip] WSL environment detected, skipping repository setup"
fi
